<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SECOMSA · Mapa de Residus</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  :root{
    --bg:#f8fafc; --panel:#ffffff; --ink:#0f172a; --muted:#64748b; --accent:#0ea5e9; --border:#e2e8f0;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  header{padding:14px 16px;border-bottom:1px solid var(--border);background:#fff;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  header h1{font-size:18px;margin:0;font-weight:700}
  header small{color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
  .controls select,.controls input[type="file"]{border:1px solid var(--border);background:var(--panel);padding:8px;border-radius:10px;font-size:14px}
  .controls label{display:flex;align-items:center;gap:6px;border:1px solid var(--border);padding:8px 10px;border-radius:10px;background:var(--panel);font-size:14px}
  #map{height:calc(100vh - 70px);width:100%}
  .legend{position:absolute;bottom:16px;left:12px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow:0 6px 18px rgba(2,8,23,.08);font-size:13px}
  .legend h4{margin:0 0 6px 0;font-size:13px}
  .legend .scale{display:flex;align-items:center;gap:6px}
  .legend .box{width:18px;height:12px;border-radius:3px;border:1px solid #e5e7eb}
  .pill{display:inline-block;background:#e6f7ff;color:#0369a1;padding:2px 8px;border-radius:999px;font-size:12px}
  .popup h3{margin:0 0 6px 0;font-size:16px}
  .popup .grid{display:grid;grid-template-columns:auto auto;gap:6px 12px;font-size:13px}
</style>
</head>
<body>
<header>
  <div>
    <h1>SECOMSA · Mapa de Residus</h1>
    <small>Dades per municipi · RSU, orgànica, cost, incidències</small>
  </div>
  <div class="controls">
    <select id="period"></select>
    <select id="metric">
      <option value="rsu_tn">RSU (t)</option>
      <option value="org_tn">Orgànica (t)</option>
      <option value="cost_eur">Cost (€)</option>
      <option value="incidencies">Incidències</option>
    </select>
    <label><input type="checkbox" id="percapita" /> per càpita</label>
    <input type="file" id="file" accept=".json,application/json" />
  </div>
</header>
<div id="map"></div>
<div class="legend" id="legend" style="display:none;">
  <h4 id="legend-title">Escala</h4>
  <div class="scale" id="legend-scale"></div>
  <div style="margin-top:6px;color:#64748b" id="legend-note"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
/* ===================== DADES D’EXEMPLE (substitueix-les carregant el teu JSON) ===================== */
let data = {
  "municipis":[
    {"id":"43001","nom":"Municipi A","lat":41.156,"lng":1.135,"poblacio":5200,
      "kpi":{"2024-01":{"rsu_tn":120.5,"org_tn":18.2,"cost_eur":15400,"incidencies":6},
             "2024-02":{"rsu_tn":115.0,"org_tn":17.9,"cost_eur":14950,"incidencies":4}}},
    {"id":"43002","nom":"Municipi B","lat":41.19,"lng":1.25,"poblacio":11800,
      "kpi":{"2024-01":{"rsu_tn":260.2,"org_tn":41.3,"cost_eur":31800,"incidencies":10},
             "2024-02":{"rsu_tn":255.4,"org_tn":39.9,"cost_eur":31150,"incidencies":12}}},
    {"id":"43003","nom":"Municipi C","lat":41.06,"lng":1.05,"poblacio":3400,
      "kpi":{"2024-01":{"rsu_tn":72.1,"org_tn":9.2,"cost_eur":8900,"incidencies":2},
             "2024-02":{"rsu_tn":69.8,"org_tn":8.6,"cost_eur":8700,"incidencies":1}}}
  ]
};
/* ================================================================================================== */

const map = L.map('map', { zoomControl: true, attributionControl: true })
  .setView([41.15, 1.2], 10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
}).addTo(map);

const cluster = L.markerClusterGroup({ showCoverageOnHover:false, disableClusteringAtZoom:12 });
let markers = [];
const $period = document.getElementById('period');
const $metric = document.getElementById('metric');
const $percap = document.getElementById('percapita');
const $file = document.getElementById('file');
const $legend = document.getElementById('legend');
const $legendTitle = document.getElementById('legend-title');
const $legendScale = document.getElementById('legend-scale');
const $legendNote = document.getElementById('legend-note');

function availablePeriods(d){
  const set = new Set();
  d.municipis.forEach(m => { if (m.kpi) Object.keys(m.kpi).forEach(k=>set.add(k)); });
  return Array.from(set).sort(); // YYYY-MM asc
}

function fillPeriodSelect(){
  const periods = availablePeriods(data);
  $period.innerHTML = "";
  periods.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p; opt.textContent = p;
    $period.appendChild(opt);
  });
  if (periods.length) $period.value = periods[periods.length-1]; // últim mes
}

function computeStats(metric, period, perCapita){
  const values = [];
  for (const m of data.municipis){
    const v = m.kpi?.[period]?.[metric];
    if (typeof v === "number"){
      const val = perCapita && m.poblacio ? v / m.poblacio : v;
      values.push(val);
    }
  }
  values.sort((a,b)=>a-b);
  const q = (p)=> values.length? values[Math.floor(p*(values.length-1))] : 0;
  return {
    min: values[0] ?? 0,
    q1: q(0.25),
    med: q(0.5),
    q3: q(0.75),
    max: values[values.length-1] ?? 0
  };
}

function colorFor(val, s){
  if (val <= s.q1) return '#d1fae5'; // verd clar
  if (val <= s.med) return '#86efac';
  if (val <= s.q3) return '#4ade80';
  return '#22c55e';
}

function radiusFor(val, s){ // escala suau segons rang
  if (s.max === s.min) return 10;
  const t = (val - s.min) / (s.max - s.min);
  return 6 + t*18; // 6..24 px
}

function formatValue(metric, val, perCapita){
  if (val == null || isNaN(val)) return "-";
  const n = perCapita ? val : val;
  if (metric === "cost_eur") return (perCapita ? (n).toFixed(2)+" €/hab" : new Intl.NumberFormat('ca-ES').format(n) + " €");
  if (metric === "rsu_tn" || metric === "org_tn") return (perCapita ? (n).toFixed(4)+" t/hab" : n.toFixed(1)+" t");
  if (metric === "incidencies") return (perCapita ? (n).toFixed(4)+" /hab" : n.toFixed(0));
  return String(n);
}

function niceMetricName(key){
  return {
    rsu_tn: "RSU (tones)",
    org_tn: "Orgànica (tones)",
    cost_eur: "Cost (€)",
    incidencies: "Incidències"
  }[key] || key;
}

function buildLegend(s, metric, perCapita){
  $legend.style.display = 'block';
  $legendTitle.textContent = "Escala · " + niceMetricName(metric) + (perCapita? " (per càpita)":"");
  $legendScale.innerHTML = "";
  const steps = [s.min, s.q1, s.med, s.q3, s.max];
  for (let i=0;i<4;i++){
    const v1 = steps[i], v2 = steps[i+1];
    const mid = (v1+v2)/2;
    const box = document.createElement('div'); box.className='box';
    box.style.background = colorFor(mid, s);
    $legendScale.appendChild(box);
  }
  $legendNote.textContent = `min: ${steps[0].toFixed(3)} · q1: ${steps[1].toFixed(3)} · med: ${steps[2].toFixed(3)} · q3: ${steps[3].toFixed(3)} · max: ${steps[4].toFixed(3)}`;
}

function render(){
  cluster.clearLayers();
  markers = [];
  const period = $period.value;
  const metric = $metric.value;
  const perCapita = $percap.checked;

  const stats = computeStats(metric, period, perCapita);
  buildLegend(stats, metric, perCapita);

  for (const m of data.municipis){
    const rec = m.kpi?.[period];
    if (!rec) continue;
    let val = rec[metric];
    if (typeof val !== "number") continue;
    if (perCapita && m.poblacio) val = val / m.poblacio;

    const color = colorFor(val, stats);
    const radius = radiusFor(val, stats);

    const marker = L.circleMarker([m.lat, m.lng], {
      radius, color:'#0ea5e9', weight:1, fillColor: color, fillOpacity:0.85
    });

    const popup = `
      <div class="popup">
        <h3>${m.nom} <span class="pill">${period}</span></h3>
        <div class="grid">
          <div><strong>${niceMetricName(metric)}:</strong></div><div>${formatValue(metric, val, false)}</div>
          ${m.poblacio? `<div><strong>Per càpita:</strong></div><div>${formatValue(metric, val, true)}</div>` : ``}
          <div><strong>Població:</strong></div><div>${m.poblacio? new Intl.NumberFormat('ca-ES').format(m.poblacio): "-"}</div>
        </div>
      </div>
    `;
    marker.bindPopup(popup);
    markers.push(marker);
  }

  if (!markers.length){
    // Si no hi ha dades pel període/indicador seleccionat, avisa.
    const center = map.getCenter();
    const msg = L.popup().setLatLng(center).setContent("Sense dades per a la selecció actual. Prova un altre període o carrega un JSON.").openOn(map);
    return;
  }

  markers.forEach(m => cluster.addLayer(m));
  cluster.addTo(map);

  // Ajusta la vista
  const group = L.featureGroup(markers);
  map.fitBounds(group.getBounds().pad(0.2));
}

function init(){
  fillPeriodSelect();
  render();
}

$period.addEventListener('change', render);
$metric.addEventListener('change', render);
$percap.addEventListener('change', render);

// Carrega JSON local
$file.addEventListener('change', (ev)=>{
  const f = ev.target.files?.[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if (!obj.municipis || !Array.isArray(obj.municipis)) {
        alert("JSON invàlid: falta 'municipis' com a llista.");
        return;
      }
      data = obj;
      fillPeriodSelect();
      render();
    }catch(e){
      alert("No s'ha pogut llegir el JSON: " + e.message);
    }
  };
  reader.readAsText(f, 'utf-8');
});

init();
</script>
</body>
</html>